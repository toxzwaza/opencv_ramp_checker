<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>オレンジ継続時間分析レポート - ランプ検知システム</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .navbar-brand {
            font-weight: bold;
        }
        .card {
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            border: 1px solid rgba(0, 0, 0, 0.125);
        }
        .card-header {
            background-color: #007bff;
            color: white;
            font-weight: bold;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .improvement-positive {
            color: #28a745;
            font-weight: bold;
        }
        .improvement-negative {
            color: #dc3545;
            font-weight: bold;
        }
        .improvement-neutral {
            color: #6c757d;
            font-weight: bold;
        }
        .table-responsive {
            max-height: 400px;
            overflow-y: auto;
        }
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .no-data {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        .debug-badge {
            background-color: #ffc107;
            color: #000;
        }
        .normal-badge {
            background-color: #28a745;
            color: #fff;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('index') }}">
                <i class="fas fa-traffic-light"></i> ランプ検知システム
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{{ url_for('index') }}">
                    <i class="fas fa-home"></i> ホーム
                </a>
                <a class="nav-link" href="{{ url_for('settings_page') }}">
                    <i class="fas fa-cog"></i> 設定
                </a>
                <a class="nav-link active" href="{{ url_for('analysis_page') }}">
                    <i class="fas fa-chart-line"></i> 分析レポート
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- ヘッダー -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-chart-line"></i> オレンジ継続時間分析レポート
                    </div>
                    <div class="card-body">
                        <p class="mb-0">
                            <i class="fas fa-clock"></i> 最終更新: {{ current_time }}
                        </p>
                        {% if error %}
                        <div class="alert alert-danger mt-2">
                            <i class="fas fa-exclamation-triangle"></i> エラー: {{ error }}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        {% if durations %}
        <!-- 統計サマリー -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <h5 class="card-title">
                            <i class="fas fa-list-ol"></i> 総記録数
                        </h5>
                        <h2 class="mb-0">{{ stats.total_count }}</h2>
                        <small>回</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <h5 class="card-title">
                            <i class="fas fa-stopwatch"></i> 平均継続時間
                        </h5>
                        <h2 class="mb-0">{{ "%.1f"|format(stats.average_duration) }}</h2>
                        <small>秒</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <h5 class="card-title">
                            <i class="fas fa-arrow-up"></i> 最長継続時間
                        </h5>
                        <h2 class="mb-0">{{ "%.1f"|format(stats.max_duration) }}</h2>
                        <small>秒</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <h5 class="card-title">
                            <i class="fas fa-arrow-down"></i> 最短継続時間
                        </h5>
                        <h2 class="mb-0">{{ "%.1f"|format(stats.min_duration) }}</h2>
                        <small>秒</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- 改善状況 -->
        {% if stats.improvement is defined %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-trending-up"></i> 改善状況分析
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>継続時間の変化</h6>
                                {% if stats.improvement > 0 %}
                                <p class="improvement-positive">
                                    <i class="fas fa-arrow-down"></i> {{ "%.1f"|format(stats.improvement) }}秒 短縮
                                    ({{ "%.1f"|format(stats.improvement_percentage) }}% 改善)
                                </p>
                                {% elif stats.improvement < 0 %}
                                <p class="improvement-negative">
                                    <i class="fas fa-arrow-up"></i> {{ "%.1f"|format(-stats.improvement) }}秒 延長
                                    ({{ "%.1f"|format(-stats.improvement_percentage) }}% 悪化)
                                </p>
                                {% else %}
                                <p class="improvement-neutral">
                                    <i class="fas fa-minus"></i> 変化なし
                                </p>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <h6>最近の平均 (最新5件)</h6>
                                <p><strong>{{ "%.1f"|format(stats.recent_average) }}秒</strong></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- ガントチャート表示 -->
        {% if gantt_chart_data %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-chart-bar"></i> ランプ検知タイムライン (過去24時間)</span>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-light" onclick="updateGanttChart(6)">6時間</button>
                            <button type="button" class="btn btn-outline-light" onclick="updateGanttChart(12)">12時間</button>
                            <button type="button" class="btn btn-light active" onclick="updateGanttChart(24)">24時間</button>
                            <button type="button" class="btn btn-outline-light" onclick="updateGanttChart(72)">3日</button>
                            <button type="button" class="btn btn-outline-light" onclick="updateGanttChart(168)">1週間</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <div id="gantt-loading" class="text-center" style="display: none;">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">読み込み中...</span>
                                </div>
                                <p class="mt-2">ガントチャートを更新中...</p>
                            </div>
                            <img id="gantt-chart" src="data:image/png;base64,{{ gantt_chart_data }}" class="img-fluid" alt="ランプ検知タイムライン">
                        </div>
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="fas fa-info-circle"></i> 
                                オレンジ・緑・不明の状態変化を時系列で表示します。長い区間には継続時間が表示されます。
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- 継続時間推移グラフ表示 -->
        {% if chart_data %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-chart-line"></i> オレンジ継続時間推移グラフ
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <img src="data:image/png;base64,{{ chart_data }}" class="img-fluid" alt="継続時間推移グラフ">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- データテーブル -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-table"></i> 詳細データ (最新30件)
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th scope="col">#</th>
                                        <th scope="col">発生時刻</th>
                                        <th scope="col">継続時間</th>
                                        <th scope="col">オレンジ検知率</th>
                                        <th scope="col">緑検知率</th>
                                        <th scope="col">モード</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for duration in durations[-30:] %}
                                    <tr>
                                        <th scope="row">{{ loop.revindex }}</th>
                                        <td>{{ duration.timestamp }}</td>
                                        <td>
                                            <strong>{{ "%.1f"|format(duration.duration) }}秒</strong>
                                            {% if duration.duration > stats.average_duration %}
                                            <i class="fas fa-arrow-up text-danger ms-1" title="平均より長い"></i>
                                            {% elif duration.duration < stats.average_duration %}
                                            <i class="fas fa-arrow-down text-success ms-1" title="平均より短い"></i>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar bg-warning" role="progressbar" 
                                                     style="width: {{ duration.orange_percentage }}%"
                                                     aria-valuenow="{{ duration.orange_percentage }}" 
                                                     aria-valuemin="0" aria-valuemax="100">
                                                    {{ "%.1f"|format(duration.orange_percentage) }}%
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar bg-success" role="progressbar" 
                                                     style="width: {{ duration.green_percentage }}%"
                                                     aria-valuenow="{{ duration.green_percentage }}" 
                                                     aria-valuemin="0" aria-valuemax="100">
                                                    {{ "%.1f"|format(duration.green_percentage) }}%
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            {% if duration.mode == 'debug' %}
                                            <span class="badge debug-badge">
                                                <i class="fas fa-bug"></i> デバッグ
                                            </span>
                                            {% else %}
                                            <span class="badge normal-badge">
                                                <i class="fas fa-check"></i> 通常
                                            </span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% else %}
        <!-- データなしの場合 -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body no-data">
                        <i class="fas fa-chart-line fa-4x text-muted mb-3"></i>
                        <h4 class="text-muted">分析データがありません</h4>
                        <p class="text-muted">
                            オレンジランプの継続時間データが見つかりません。<br>
                            システムを実行してデータを収集してください。
                        </p>
                        <a href="{{ url_for('index') }}" class="btn btn-primary">
                            <i class="fas fa-home"></i> ホームに戻る
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- 自動更新ボタン -->
        <div class="row mt-4 mb-4">
            <div class="col-12 text-center">
                <button type="button" class="btn btn-primary btn-lg" onclick="location.reload()">
                    <i class="fas fa-sync-alt"></i> データを更新
                </button>
                <a href="{{ url_for('index') }}" class="btn btn-secondary btn-lg ms-2">
                    <i class="fas fa-home"></i> ホームに戻る
                </a>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- 自動更新機能とガントチャート更新機能 -->
    <script>
        // 5分ごとに自動更新
        setInterval(function() {
            location.reload();
        }, 300000); // 300000ms = 5分

        // ガントチャートの時間範囲を更新
        function updateGanttChart(hours) {
            const loadingElement = document.getElementById('gantt-loading');
            const chartElement = document.getElementById('gantt-chart');
            
            if (!loadingElement || !chartElement) {
                console.error('ガントチャート要素が見つかりません');
                return;
            }
            
            // ローディング表示
            loadingElement.style.display = 'block';
            chartElement.style.display = 'none';
            
            // ボタンの状態を更新
            document.querySelectorAll('.btn-group .btn').forEach(btn => {
                btn.classList.remove('active', 'btn-light');
                btn.classList.add('btn-outline-light');
            });
            event.target.classList.remove('btn-outline-light');
            event.target.classList.add('btn-light', 'active');
            
            // ヘッダーのテキストを更新
            const headerText = document.querySelector('.card-header span');
            if (headerText) {
                let timeText = '';
                if (hours === 6) timeText = '6時間';
                else if (hours === 12) timeText = '12時間';
                else if (hours === 24) timeText = '24時間';
                else if (hours === 72) timeText = '3日';
                else if (hours === 168) timeText = '1週間';
                headerText.innerHTML = `<i class="fas fa-chart-bar"></i> ランプ検知タイムライン (過去${timeText})`;
            }
            
            // APIからガントチャートデータを取得
            fetch(`/api/analysis/gantt?hours=${hours}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        chartElement.src = 'data:image/png;base64,' + data.gantt_chart_data;
                        chartElement.style.display = 'block';
                        loadingElement.style.display = 'none';
                    } else {
                        console.error('ガントチャート取得エラー:', data.error);
                        alert('ガントチャートの更新に失敗しました: ' + data.error);
                        loadingElement.style.display = 'none';
                        chartElement.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('ガントチャート取得エラー:', error);
                    alert('ガントチャートの更新中にエラーが発生しました');
                    loadingElement.style.display = 'none';
                    chartElement.style.display = 'block';
                });
        }

        // ページ読み込み時にメッセージ表示
        document.addEventListener('DOMContentLoaded', function() {
            {% if durations %}
            console.log('分析データ: {{ durations|length }}件のレコードを読み込みました');
            {% else %}
            console.log('分析データが見つかりません');
            {% endif %}
            
            {% if gantt_chart_data %}
            console.log('ガントチャートが利用可能です');
            {% endif %}
        });
    </script>
</body>
</html>



{% extends "base.html" %}

{% block title %}座標設定 - ランプ検知システム{% endblock %}

{% block styles %}
<style>
    #image-container {
        position: relative;
        display: inline-block;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        overflow: hidden;
        max-width: 100%;
    }
    
    #coordinate-image {
        display: block;
        max-width: 100%;
        height: auto;
    }
    
    .coordinate-box {
        position: absolute;
        border: 3px solid;
        cursor: move;
        background-color: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(1px);
    }
    
    .coordinate-box.orange {
        border-color: #ff6600;
        background-color: rgba(255, 102, 0, 0.2);
    }
    
    .coordinate-box.green {
        border-color: #28a745;
        background-color: rgba(40, 167, 69, 0.2);
    }
    
    .coordinate-box.active {
        border-width: 4px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
    }
    
    .coordinate-label {
        position: absolute;
        top: -25px;
        left: 0;
        background-color: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
        white-space: nowrap;
    }
    
    .resize-handle {
        position: absolute;
        width: 10px;
        height: 10px;
        background-color: rgba(255, 255, 255, 0.8);
        border: 2px solid;
        border-radius: 50%;
        cursor: nw-resize;
        right: -5px;
        bottom: -5px;
    }
    
    .resize-handle.orange {
        border-color: #ff6600;
    }
    
    .resize-handle.green {
        border-color: #28a745;
    }
    
    .coordinate-info {
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
    }
    
    .image-controls {
        margin-bottom: 20px;
    }
    
    .btn-group-toggle .btn {
        margin-right: 5px;
    }
    
    #image-upload-area {
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        padding: 40px;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    #image-upload-area:hover {
        border-color: #007bff;
        background-color: #f8f9fa;
    }
    
    #image-upload-area.dragover {
        border-color: #28a745;
        background-color: #d4edda;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-crosshairs text-warning"></i> 座標設定</h2>
            <div>
                <button id="save-coordinates" class="btn btn-success">
                    <i class="fas fa-save"></i> 座標を保存
                </button>
                <button id="reset-coordinates" class="btn btn-warning">
                    <i class="fas fa-undo"></i> リセット
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 画像コントロール -->
<div class="row">
    <div class="col-12">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-image"></i> 画像選択
                </h5>
            </div>
            <div class="card-body">
                <div class="image-controls">
                    <div class="btn-group" role="group">
                        <button id="load-latest" class="btn btn-primary">
                            <i class="fas fa-download"></i> 最新画像を読み込み
                        </button>
                        <button id="capture-new" class="btn btn-info">
                            <i class="fas fa-camera"></i> カメラでキャプチャ
                        </button>
                        <label for="image-file" class="btn btn-secondary">
                            <i class="fas fa-upload"></i> ファイルをアップロード
                        </label>
                    </div>
                    <input type="file" id="image-file" accept="image/*" style="display: none;">
                </div>
                
                <!-- ドラッグ&ドロップエリア -->
                <div id="image-upload-area" style="display: none;">
                    <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                    <p class="text-muted">画像ファイルをここにドラッグ&ドロップするか、クリックして選択してください</p>
                    <small class="text-muted">対応形式: PNG, JPG, JPEG</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 座標設定エリア -->
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-crosshairs"></i> 座標設定エリア
                </h5>
            </div>
            <div class="card-body text-center">
                <div id="image-container" style="display: none;">
                    <img id="coordinate-image" src="" alt="座標設定用画像">
                    <!-- 座標ボックスはJavaScriptで動的に追加 -->
                </div>
                <div id="no-image-message">
                    <i class="fas fa-image fa-3x text-muted mb-3"></i>
                    <p class="text-muted">画像を読み込んでください</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-info-circle"></i> 座標情報
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <h6 class="text-warning">
                        <i class="fas fa-circle" style="color: #ff6600;"></i> オレンジランプ
                    </h6>
                    <div class="coordinate-info">
                        <div>X1: <span id="orange-x1">-</span></div>
                        <div>Y1: <span id="orange-y1">-</span></div>
                        <div>X2: <span id="orange-x2">-</span></div>
                        <div>Y2: <span id="orange-y2">-</span></div>
                        <div>サイズ: <span id="orange-size">-</span></div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <h6 class="text-success">
                        <i class="fas fa-circle" style="color: #28a745;"></i> 緑ランプ
                    </h6>
                    <div class="coordinate-info">
                        <div>X1: <span id="green-x1">-</span></div>
                        <div>Y1: <span id="green-y1">-</span></div>
                        <div>X2: <span id="green-x2">-</span></div>
                        <div>Y2: <span id="green-y2">-</span></div>
                        <div>サイズ: <span id="green-size">-</span></div>
                    </div>
                </div>
                
                <hr>
                
                <div class="alert alert-info">
                    <small>
                        <strong>使用方法:</strong><br>
                        • ボックスをドラッグして位置を調整<br>
                        • 右下のハンドルでサイズ変更<br>
                        • クリックで選択状態を切り替え
                    </small>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-tools"></i> 便利機能
                </h5>
            </div>
            <div class="card-body">
                <button id="auto-detect" class="btn btn-outline-primary btn-sm w-100 mb-2">
                    <i class="fas fa-magic"></i> 自動検出（試験的）
                </button>
                <button id="center-boxes" class="btn btn-outline-secondary btn-sm w-100 mb-2">
                    <i class="fas fa-align-center"></i> 中央に配置
                </button>
                <button id="equal-size" class="btn btn-outline-info btn-sm w-100">
                    <i class="fas fa-expand-arrows-alt"></i> 同じサイズに調整
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
class CoordinateManager {
    constructor() {
        this.imageContainer = document.getElementById('image-container');
        this.coordinateImage = document.getElementById('coordinate-image');
        this.noImageMessage = document.getElementById('no-image-message');
        
        this.coordinates = {
            orange: { x1: 317, y1: 97, x2: 362, y2: 145 },
            green: { x1: 315, y1: 130, x2: 363, y2: 180 }
        };
        
        this.boxes = {};
        this.activeBox = null;
        this.isDragging = false;
        this.isResizing = false;
        this.dragOffset = { x: 0, y: 0 };
        
        this.init();
    }
    
    init() {
        this.setupEventListeners();
        this.loadSettings();
    }
    
    setupEventListeners() {
        // 画像コントロール
        document.getElementById('load-latest').addEventListener('click', () => this.loadLatestImage());
        document.getElementById('capture-new').addEventListener('click', () => this.captureNewImage());
        document.getElementById('image-file').addEventListener('change', (e) => this.handleFileUpload(e));
        
        // 座標操作
        document.getElementById('save-coordinates').addEventListener('click', () => this.saveCoordinates());
        document.getElementById('reset-coordinates').addEventListener('click', () => this.resetCoordinates());
        
        // 便利機能
        document.getElementById('auto-detect').addEventListener('click', () => this.autoDetect());
        document.getElementById('center-boxes').addEventListener('click', () => this.centerBoxes());
        document.getElementById('equal-size').addEventListener('click', () => this.equalSize());
        
        // ドラッグ&ドロップ
        const uploadArea = document.getElementById('image-upload-area');
        uploadArea.addEventListener('click', () => document.getElementById('image-file').click());
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                this.uploadImage(files[0]);
            }
        });
        
        // 画像読み込み完了時
        this.coordinateImage.addEventListener('load', () => this.onImageLoaded());
    }
    
    async loadSettings() {
        try {
            const response = await fetch('/api/settings');
            const settings = await response.json();
            if (settings.coordinates) {
                this.coordinates = settings.coordinates;
            }
        } catch (error) {
            console.error('設定の読み込みに失敗:', error);
        }
    }
    
    async loadLatestImage() {
        try {
            const response = await fetch('/api/image/latest');
            if (response.ok) {
                const blob = await response.blob();
                const imageUrl = URL.createObjectURL(blob);
                this.loadImage(imageUrl);
                showAlert('最新画像を読み込みました', 'success');
            } else {
                showAlert('最新画像の読み込みに失敗しました', 'warning');
            }
        } catch (error) {
            console.error('最新画像の読み込みエラー:', error);
            showAlert('最新画像の読み込みに失敗しました', 'danger');
        }
    }
    
    async captureNewImage() {
        try {
            showAlert('カメラから画像をキャプチャ中...', 'info');
            const response = await fetch('/api/image/capture', { method: 'POST' });
            const result = await response.json();
            
            if (result.success) {
                // キャプチャした画像を読み込み
                this.loadImage(`/api/image/${result.image_path.split('/').pop()}`);
                showAlert(result.message, 'success');
            } else {
                showAlert(result.message, 'danger');
            }
        } catch (error) {
            console.error('画像キャプチャエラー:', error);
            showAlert('画像キャプチャに失敗しました', 'danger');
        }
    }
    
    handleFileUpload(event) {
        const file = event.target.files[0];
        if (file) {
            this.uploadImage(file);
        }
    }
    
    async uploadImage(file) {
        try {
            const formData = new FormData();
            formData.append('image', file);
            
            showAlert('画像をアップロード中...', 'info');
            const response = await fetch('/api/image/upload', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            if (result.success) {
                this.loadImage(`/api/image/${result.image_path.split('/').pop()}`);
                showAlert(result.message, 'success');
            } else {
                showAlert(result.message, 'danger');
            }
        } catch (error) {
            console.error('画像アップロードエラー:', error);
            showAlert('画像アップロードに失敗しました', 'danger');
        }
    }
    
    loadImage(imageSrc) {
        this.coordinateImage.src = imageSrc;
        this.noImageMessage.style.display = 'none';
        this.imageContainer.style.display = 'inline-block';
    }
    
    onImageLoaded() {
        this.createCoordinateBoxes();
        this.updateCoordinateDisplay();
    }
    
    createCoordinateBoxes() {
        // 既存のボックスを削除
        Object.values(this.boxes).forEach(box => {
            if (box.element) {
                box.element.remove();
            }
        });
        
        const imageRect = this.coordinateImage.getBoundingClientRect();
        const containerRect = this.imageContainer.getBoundingClientRect();
        
        // 画像の実際のサイズとコンテナ内での表示サイズの比率を計算
        const scaleX = this.coordinateImage.naturalWidth / this.coordinateImage.offsetWidth;
        const scaleY = this.coordinateImage.naturalHeight / this.coordinateImage.offsetHeight;
        
        ['orange', 'green'].forEach(color => {
            const coords = this.coordinates[color];
            
            // 表示サイズに合わせて座標を調整
            const x1 = coords.x1 / scaleX;
            const y1 = coords.y1 / scaleY;
            const x2 = coords.x2 / scaleX;
            const y2 = coords.y2 / scaleY;
            
            const box = this.createBox(color, x1, y1, x2 - x1, y2 - y1);
            this.boxes[color] = {
                element: box,
                scaleX: scaleX,
                scaleY: scaleY
            };
        });
    }
    
    createBox(color, x, y, width, height) {
        const box = document.createElement('div');
        box.className = `coordinate-box ${color}`;
        box.style.left = `${x}px`;
        box.style.top = `${y}px`;
        box.style.width = `${width}px`;
        box.style.height = `${height}px`;
        
        // ラベル
        const label = document.createElement('div');
        label.className = 'coordinate-label';
        label.textContent = color === 'orange' ? 'オレンジ' : '緑';
        box.appendChild(label);
        
        // リサイズハンドル
        const handle = document.createElement('div');
        handle.className = `resize-handle ${color}`;
        box.appendChild(handle);
        
        // イベントリスナー
        this.setupBoxEventListeners(box, color, handle);
        
        this.imageContainer.appendChild(box);
        return box;
    }
    
    setupBoxEventListeners(box, color, handle) {
        // ボックスクリック（選択）
        box.addEventListener('click', (e) => {
            e.stopPropagation();
            this.setActiveBox(color);
        });
        
        // ドラッグ開始
        box.addEventListener('mousedown', (e) => {
            if (e.target === handle) return; // リサイズハンドルの場合は除外
            
            e.preventDefault();
            this.isDragging = true;
            this.setActiveBox(color);
            
            const rect = box.getBoundingClientRect();
            const containerRect = this.imageContainer.getBoundingClientRect();
            
            this.dragOffset.x = e.clientX - rect.left;
            this.dragOffset.y = e.clientY - rect.top;
            
            document.addEventListener('mousemove', this.handleDrag.bind(this));
            document.addEventListener('mouseup', this.handleDragEnd.bind(this));
        });
        
        // リサイズ開始
        handle.addEventListener('mousedown', (e) => {
            e.preventDefault();
            e.stopPropagation();
            this.isResizing = true;
            this.setActiveBox(color);
            
            document.addEventListener('mousemove', this.handleResize.bind(this));
            document.addEventListener('mouseup', this.handleResizeEnd.bind(this));
        });
    }
    
    setActiveBox(color) {
        // 全てのボックスから active クラスを削除
        Object.keys(this.boxes).forEach(c => {
            if (this.boxes[c].element) {
                this.boxes[c].element.classList.remove('active');
            }
        });
        
        // 指定されたボックスに active クラスを追加
        if (this.boxes[color] && this.boxes[color].element) {
            this.boxes[color].element.classList.add('active');
        }
        
        this.activeBox = color;
    }
    
    handleDrag(e) {
        if (!this.isDragging || !this.activeBox) return;
        
        const box = this.boxes[this.activeBox].element;
        const containerRect = this.imageContainer.getBoundingClientRect();
        
        let newX = e.clientX - containerRect.left - this.dragOffset.x;
        let newY = e.clientY - containerRect.top - this.dragOffset.y;
        
        // 境界チェック
        const boxWidth = parseFloat(box.style.width);
        const boxHeight = parseFloat(box.style.height);
        const imageWidth = this.coordinateImage.offsetWidth;
        const imageHeight = this.coordinateImage.offsetHeight;
        
        newX = Math.max(0, Math.min(newX, imageWidth - boxWidth));
        newY = Math.max(0, Math.min(newY, imageHeight - boxHeight));
        
        box.style.left = `${newX}px`;
        box.style.top = `${newY}px`;
        
        this.updateCoordinatesFromBox(this.activeBox);
    }
    
    handleDragEnd() {
        this.isDragging = false;
        document.removeEventListener('mousemove', this.handleDrag.bind(this));
        document.removeEventListener('mouseup', this.handleDragEnd.bind(this));
    }
    
    handleResize(e) {
        if (!this.isResizing || !this.activeBox) return;
        
        const box = this.boxes[this.activeBox].element;
        const containerRect = this.imageContainer.getBoundingClientRect();
        
        const currentLeft = parseFloat(box.style.left);
        const currentTop = parseFloat(box.style.top);
        
        let newWidth = e.clientX - containerRect.left - currentLeft;
        let newHeight = e.clientY - containerRect.top - currentTop;
        
        // 最小サイズ制限
        newWidth = Math.max(20, newWidth);
        newHeight = Math.max(20, newHeight);
        
        // 境界チェック
        const imageWidth = this.coordinateImage.offsetWidth;
        const imageHeight = this.coordinateImage.offsetHeight;
        
        newWidth = Math.min(newWidth, imageWidth - currentLeft);
        newHeight = Math.min(newHeight, imageHeight - currentTop);
        
        box.style.width = `${newWidth}px`;
        box.style.height = `${newHeight}px`;
        
        this.updateCoordinatesFromBox(this.activeBox);
    }
    
    handleResizeEnd() {
        this.isResizing = false;
        document.removeEventListener('mousemove', this.handleResize.bind(this));
        document.removeEventListener('mouseup', this.handleResizeEnd.bind(this));
    }
    
    updateCoordinatesFromBox(color) {
        const box = this.boxes[color].element;
        const scaleX = this.boxes[color].scaleX;
        const scaleY = this.boxes[color].scaleY;
        
        const left = parseFloat(box.style.left);
        const top = parseFloat(box.style.top);
        const width = parseFloat(box.style.width);
        const height = parseFloat(box.style.height);
        
        // 実際の画像座標に変換
        this.coordinates[color] = {
            x1: Math.round(left * scaleX),
            y1: Math.round(top * scaleY),
            x2: Math.round((left + width) * scaleX),
            y2: Math.round((top + height) * scaleY)
        };
        
        this.updateCoordinateDisplay();
    }
    
    updateCoordinateDisplay() {
        ['orange', 'green'].forEach(color => {
            const coords = this.coordinates[color];
            document.getElementById(`${color}-x1`).textContent = coords.x1;
            document.getElementById(`${color}-y1`).textContent = coords.y1;
            document.getElementById(`${color}-x2`).textContent = coords.x2;
            document.getElementById(`${color}-y2`).textContent = coords.y2;
            
            const width = coords.x2 - coords.x1;
            const height = coords.y2 - coords.y1;
            document.getElementById(`${color}-size`).textContent = `${width}×${height}`;
        });
    }
    
    async saveCoordinates() {
        try {
            const response = await fetch('/api/coordinates', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(this.coordinates)
            });
            
            const result = await response.json();
            if (result.success) {
                showAlert(result.message, 'success');
            } else {
                showAlert(result.message, 'danger');
            }
        } catch (error) {
            console.error('座標保存エラー:', error);
            showAlert('座標の保存に失敗しました', 'danger');
        }
    }
    
    resetCoordinates() {
        if (confirm('座標をリセットしますか？')) {
            this.coordinates = {
                orange: { x1: 317, y1: 97, x2: 362, y2: 145 },
                green: { x1: 315, y1: 130, x2: 363, y2: 180 }
            };
            
            if (this.coordinateImage.src) {
                this.createCoordinateBoxes();
                this.updateCoordinateDisplay();
            }
            
            showAlert('座標をリセットしました', 'info');
        }
    }
    
    autoDetect() {
        showAlert('自動検出機能は開発中です', 'warning');
    }
    
    centerBoxes() {
        if (!this.coordinateImage.src) {
            showAlert('画像を読み込んでください', 'warning');
            return;
        }
        
        const imageWidth = this.coordinateImage.naturalWidth;
        const imageHeight = this.coordinateImage.naturalHeight;
        const boxWidth = 50;
        const boxHeight = 50;
        
        const centerX = (imageWidth - boxWidth) / 2;
        const centerY = (imageHeight - boxHeight) / 2;
        
        this.coordinates.orange = {
            x1: Math.round(centerX),
            y1: Math.round(centerY - 30),
            x2: Math.round(centerX + boxWidth),
            y2: Math.round(centerY - 30 + boxHeight)
        };
        
        this.coordinates.green = {
            x1: Math.round(centerX),
            y1: Math.round(centerY + 30),
            x2: Math.round(centerX + boxWidth),
            y2: Math.round(centerY + 30 + boxHeight)
        };
        
        this.createCoordinateBoxes();
        this.updateCoordinateDisplay();
        showAlert('ボックスを中央に配置しました', 'success');
    }
    
    equalSize() {
        if (!this.coordinateImage.src) {
            showAlert('画像を読み込んでください', 'warning');
            return;
        }
        
        // オレンジボックスのサイズを基準に緑ボックスのサイズを調整
        const orangeCoords = this.coordinates.orange;
        const orangeWidth = orangeCoords.x2 - orangeCoords.x1;
        const orangeHeight = orangeCoords.y2 - orangeCoords.y1;
        
        const greenCoords = this.coordinates.green;
        this.coordinates.green = {
            x1: greenCoords.x1,
            y1: greenCoords.y1,
            x2: greenCoords.x1 + orangeWidth,
            y2: greenCoords.y1 + orangeHeight
        };
        
        this.createCoordinateBoxes();
        this.updateCoordinateDisplay();
        showAlert('ボックスサイズを統一しました', 'success');
    }
}

// ページ読み込み時に初期化
document.addEventListener('DOMContentLoaded', function() {
    new CoordinateManager();
});
</script>
{% endblock %}
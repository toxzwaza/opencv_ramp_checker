# ランプ検知システム Web管理インターフェース

## 概要

このシステムは、OpenCVを使用したランプ色判定システムにWeb管理機能を追加したものです。
従来のPythonプログラムでの座標設定に加えて、ウェブブラウザから直感的に座標設定や設定管理が可能になりました。

## 主な機能

### 🎯 座標設定
- **ウェブブラウザ上での直感的な座標設定**
- 画像のアップロード・カメラキャプチャ対応
- クリック・ドラッグによるリアルタイム座標調整
- オレンジ・緑ランプの検知範囲を視覚的に設定

### ⚙️ 設定管理
- 検知閾値、通知設定の Web UI からの変更
- リアルタイム設定プレビュー
- JSON形式での設定確認・編集

### 📊 監視状況
- ライブカメラ映像の表示
- 検知ログのリアルタイム表示
- システム状態の監視・制御

## インストール・起動方法

### 1. 依存関係のインストール

```bash
pip install -r requirements.txt
```

### 2. Webアプリケーションの起動

```bash
python app.py
```

### 3. ブラウザでアクセス

```
http://localhost:5000
```

## 使用方法

### 初回設定

1. **座標設定**
   - `http://localhost:5000/coordinates` にアクセス
   - 「カメラでキャプチャ」または「画像をアップロード」で画像を読み込み
   - オレンジと緑のボックスをドラッグ・リサイズして位置を調整
   - 「座標を保存」をクリック

2. **設定調整**
   - `http://localhost:5000/settings` にアクセス
   - 検知閾値、通知設定などを必要に応じて調整
   - 「設定を保存」をクリック

3. **監視開始**
   - `http://localhost:5000/monitoring` にアクセス
   - 「監視開始」ボタンをクリック

### 座標設定の詳細

#### 基本操作
- **ボックス移動**: ボックスをクリック・ドラッグ
- **サイズ変更**: 右下のハンドルをドラッグ
- **選択切り替え**: ボックスをクリックして選択状態を切り替え

#### 便利機能
- **中央に配置**: ボックスを画像中央に配置
- **同じサイズに調整**: オレンジボックスのサイズに緑ボックスを合わせる
- **自動検出**: 将来的な自動検出機能（開発中）

#### 画像の読み込み方法
1. **最新画像を読み込み**: 既存のsample_imgから最新画像を読み込み
2. **カメラでキャプチャ**: USBカメラから新しい画像をキャプチャ
3. **ファイルをアップロード**: PCから画像ファイルをアップロード
4. **ドラッグ&ドロップ**: 画像ファイルを直接ドラッグ&ドロップ

## ファイル構成

```
opencv_ramp_checker/
├── app.py                 # Flask Webアプリケーション
├── main.py               # 既存の検知システム
├── setting.json          # 設定ファイル
├── templates/            # HTMLテンプレート
│   ├── base.html
│   ├── index.html
│   ├── coordinates.html
│   ├── settings.html
│   └── monitoring.html
├── sample_img/           # 画像ファイル
├── streaming/            # ライブ画像保存先
└── requirements.txt      # 依存関係
```

## API エンドポイント

### 設定関連
- `GET /api/settings` - 設定取得
- `POST /api/settings` - 設定更新
- `POST /api/coordinates` - 座標更新

### 画像関連
- `GET /api/image/latest` - 最新画像取得
- `POST /api/image/capture` - カメラキャプチャ
- `POST /api/image/upload` - 画像アップロード

### 監視関連
- `POST /api/monitoring/start` - 監視開始
- `POST /api/monitoring/stop` - 監視停止
- `GET /api/monitoring/status` - 監視状態取得

## 従来システムとの互換性

- 既存の `main.py` はそのまま使用可能
- `setting.json` の形式は変更なし
- コマンドライン実行も引き続き対応

## トラブルシューティング

### カメラが認識されない場合
1. USBカメラが正しく接続されているか確認
2. 他のアプリケーションがカメラを使用していないか確認
3. 設定管理でカメラインデックスを変更してみる

### 座標が正しく保存されない場合
1. ブラウザのコンソールでエラーメッセージを確認
2. `setting.json` ファイルの権限を確認
3. Webアプリケーションを再起動

### 画像が表示されない場合
1. `sample_img` フォルダに画像ファイルがあるか確認
2. 画像ファイルの形式（PNG, JPG, JPEG）を確認
3. ファイルサイズが16MB以下か確認

## セキュリティ注意事項

- このWebアプリケーションは開発・テスト用途を想定しています
- 本番環境で使用する場合は、適切な認証・認可機能を追加してください
- ファイアウォールの設定に注意してください

## 今後の拡張予定

- [ ] ユーザー認証機能
- [ ] 複数カメラ対応
- [ ] 検知結果のグラフ表示
- [ ] 自動座標検出機能
- [ ] スマートフォン対応UI
- [ ] データベース連携

## サポート

質問や問題がある場合は、システム管理者にお問い合わせください。
